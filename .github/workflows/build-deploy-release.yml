name: Build MyST site, Deploy Pages and Create Release

on:
push:
branches: [main]
tags: ["v*.*.*"]

env:
BASE_URL: /${{ github.event.repository.name }}

permissions:
contents: write
pages: write
id-token: write

concurrency:
group: "pages"
cancel-in-progress: false

jobs:
build:
runs-on: ubuntu-latest


steps:
  - uses: actions/checkout@v4

  - uses: actions/setup-node@v4
    with:
      node-version: 18.x

  - name: Install MyST
    run: npm install -g mystmd

  - name: Build HTML
    run: myst build --html

  - name: Zip HTML site
    run: |
      cd _build
      zip -r myst-site.zip html

  - name: Upload build artifact
    uses: actions/upload-artifact@v4
    with:
      name: myst-site
      path: |
        _build/html
        _build/myst-site.zip

deploy-pages:
if: github.ref == 'refs/heads/main'
needs: build
runs-on: ubuntu-latest
environment:
name: github-pages
url: ${{ steps.deployment.outputs.page_url }}

steps:
  - uses: actions/download-artifact@v4
    with:
      name: myst-site
      path: _build

  - name: Setup Pages
    uses: actions/configure-pages@v3

  - name: Upload Pages artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: '_build/html'

  - name: Deploy to GitHub Pages
    id: deployment
    uses: actions/deploy-pages@v4

release:
if: startsWith(github.ref, 'refs/tags/')
needs: build
runs-on: ubuntu-latest

steps:
  - uses: actions/download-artifact@v4
    with:
      name: myst-site
      path: _build

  - name: Rename ZIP with version
    run: |
      mv _build/myst-site.zip _build/myst-site-${{ github.ref_name }}.zip

  - name: Create GitHub Release
    uses: softprops/action-gh-release@v2
    with:
      files: _build/myst-site-${{ github.ref_name }}.zip
      generate_release_notes: true
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
